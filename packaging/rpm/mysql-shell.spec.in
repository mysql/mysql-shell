# Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License, version 2.0,
# as published by the Free Software Foundation.
#
# This program is also distributed with certain software (including
# but not limited to OpenSSL) that is licensed under separate terms, as
# designated in a particular file or component or in included license
# documentation.  The authors of MySQL hereby grant you an additional
# permission to link the program and your derivative works with the
# separately licensed software that they have included with MySQL.
# This program is distributed in the hope that it will be useful,  but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See
# the GNU General Public License, version 2.0, for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA

%{?with_static: %global static 1}

%global commercial  @COMMERCIAL_VER@

%if 0%{?commercial}
%global product_suffix @PRODUCT_SUFFIX@
%endif

# define v8_includedir and v8_libdir for rpmbuild when building static

Summary:        Command line shell and scripting environment for MySQL
Name:           mysql-shell@PRODUCT_SUFFIX@
Version:        @MYSH_NO_DASH_VERSION@
Release:        @RPM_RELEASE@%{?dist}
License:        @LICENSE_TYPE@
URL:            http://dev.mysql.com/
Source0:        https://cdn.mysql.com/Downloads/%{name}-@MYSH_VERSION@-src.tar.gz

# Most runtime deps the RPM build tools figures out, like the dependency
# on "libpython2.7.so". But it can't know about the dependency on the
# standard Python modules, i.e. almost all of a normal Python install
%if 0%{?suse_version}
Requires:       python-base
%else
Requires:       python2
%endif

BuildRequires:  cmake
%if 0%{!?with_protobuf:1} && 0%{!?with_mysql_source:1}
BuildRequires:  protobuf-devel
BuildRequires:  protobuf-compiler
%endif
BuildRequires:  python-devel
%if 0%{!?static}
BuildRequires:  mysql-devel
BuildRequires:  openssl-devel
BuildRequires:  libcurl-devel
#BuildRequires:  v8-devel
#BuildRequires:  v8-python
%endif
%if 0%{?commercial}
Provides:      mysql-shell = %{version}-%{release}
Obsoletes:     mysql-shell < %{version}-%{release}
%endif

%description
@PRODUCT@
a query and administration shell client and framework.

%prep
%setup -q -n %{name}-@MYSH_VERSION@-src

%build
rm -rf build && mkdir build && cd build
cmake .. \
    -DCMAKE_INSTALL_PREFIX=%{_prefix} \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo \
%if 0%{?commercial}
    -DEXTRA_NAME_SUFFIX="%{?product_suffix}" \
%endif
%if "%{_lib}" == "lib64"
    -DLIB_SUFFIX=64 \
%endif
%if 0%{?static}
    -DMYSQLCLIENT_STATIC_LINKING=ON \
    -DV8_INCLUDE_DIR=%{v8_includedir} \
    -DV8_LIB_DIR=%{v8_libdir} \
%else
    -DMYSQLCLIENT_STATIC_LINKING=ON \
    -DHAVE_V8=0FF
%endif
%if 0%{?with_protobuf:1}
    -DWITH_PROTOBUF=%{with_protobuf} \
%endif
%if 0%{?with_gmock:1}
    -DWITH_TESTS=ON \
    -DWITH_GMOCK=%{with_gmock} \
%endif
%if 0%{?with_oci:1}
    -DWITH_OCI=%{with_oci} \
%endif
%if 0%{?with_mysql_source:1}
    -DMYSQL_SOURCE_DIR="%{with_mysql_source}" \
    -DMYSQL_BUILD_DIR="%{with_mysql_source}/bld" \
    %if 0%{!?with_protobuf:1}
      -DPROTOBUF_INCLUDE_DIR="%{?with_mysql_source}/extra/protobuf/protobuf-@PROTOBUF_VERSION@/src" \
      -DPROTOBUF_LIBRARY="%{?with_mysql_source}/bld/extra/protobuf/protobuf-@PROTOBUF_VERSION@/cmake/libprotobuf.a" \
      -DPROTOBUF_LIBRARY_DEBUG="%{?with_mysql_source}/bld/extra/protobuf/protobuf-@PROTOBUF_VERSION@/cmake/libprotobuf.a"\
    %endif
%endif
    -DHAVE_PYTHON=1 \

# Supported V8 versions are limited, disable
# V8 in non static for now.
# -DV8_INCLUDE_DIR=%{_includedir}/v8 \
# -DV8_LIB_DIR=%{_libdir} \
# Shared linking don't work
# -DMYSQLCLIENT_STATIC_LINKING=ON \

make %{?_smp_mflags}

%install
cd build
make DESTDIR=%{buildroot} install
# FIXME at this moment only headers are installed but no
# "mysqlshdk" library. It is also unclear if eventually we
# want the lib and headers, in that case likely in a separate
# package. Using a work-around removing all the "dev" files
rm -rf %{buildroot}%{_includedir} 2>/dev/null
rm -f %{buildroot}%{_prefix}/lib*/*.{so*,a} 2>/dev/null
# License and readme are included using %%doc below
rm -f %{buildroot}%{_datadir}/mysqlsh/{LICENSE,README}

%files
# FIXME EL6 doesn't like 'license' macro here, so we use 'doc'
%doc LICENSE
%doc README
%{_bindir}/mysqlsh
%{_bindir}/mysql-secret-store-login-path
%{_datadir}/mysqlsh/mysqlprovision.zip
%{_datadir}/mysqlsh/prompt/*
%if 0%{?with_oci:1}
%{_datadir}/mysqlsh/oci_sdk/*
%endif
%{_datadir}/mysqlsh/upgrade_checker.msg
%{_datadir}/mysqlsh/Docs/INFO_SRC
%{_datadir}/mysqlsh/Docs/INFO_BIN

%changelog
* Mon Oct 8 2018 Rene Ramirez <j.rene.ramirez@oracle.com> - 8.0.14
- Update to use mysql server bundled protobuf if no specific is defined.

* Fri May 18 2018 Pawel Andruszkiewicz <pawel.andruszkiewicz@oracle.com> - 8.0.12
- Add login-path helper.

* Sun Dec 17 2017 Kent Boortz <kent.boortz@oracle.com> - 8.0.4-1
- License file is now always named "LICENSE"

* Wed Nov 01 2017 Alfredo Kojima <alfredo.kengi.kojima@oracle.com> - 8.0.4-1
- Remove Connector/Python dependency

* Thu May 04 2017 Alfredo Kojima <alfredo.kengi.kojima@oracle.com> - 1.0.8-1
- Remove libedit dependency, add sample prompt files

* Mon Mar 13 2017 Alfredo Kojima <alfredo.kengi.kojima@oracle.com> - 1.0.8-1
- Updated for mysqlprovision build change

* Thu Sep 01 2016 Balasubramanian Kandasamy <balasubramanian.kandasamy@oracle.com> - 1.0.5-0.1
- Updated for 1.0.5 labs release

* Wed Mar 23 2016 Alfredo Kojima <alfredo.kengi.kojima@oracle.com> - 1.0.3-1
- updated for 1.0.3, bug fixes

* Mon Mar 14 2016 Kent Boortz <kent.boortz@oracle.com> - 1.0.2.8-1
- initial package
